# wise2c 应用容器化流程标准

## 一、 基础容器化原则

1. 尽量重用和使用网上公开的官网基础镜像 \(安全及最佳实践原因，自己定制的镜像往往考虑不到bug及优化的最佳实践）

2. 使用dockerfile 尽量到最基础层面开始自动构建包括用户软件（最大程度的保证构建的灵活性（在各级支持自动构建来变更，为ci\/cd打好基础架构。在一定程度上保证镜像的最小化及全环境统一），尽量达到一次构建任意运行 。

3. 构建目标\(Docker images\) 不建议放置在运行期间需要修改的配置文件 （使用服务解决方案）

  A. 对于应用程序读取环境配置而言，一个优雅的解决方案是把环境相关的配置信息做为可使用的变量暴露给应用程序。这种方法比硬编码、在程序中使用分支判断和部署时的参数注入要好的多，能够使应用程序轻松兼容到任意的环境平台。

  B.  volume 配置注入方式，可以使用volume from  将配置注入，好处是重新构建时，只需构建配置镜像。
  C. 使用entrypoint 给定脚本变更方式。 
  D. 配置剥离 （ETCD\/ZOOKEEPER\)。

4. 不建议加ssh 工具 （应用的更新，变更待推荐使用容器部署更新方式，在个别容器内更改不符合容器云平台的最佳实践，不方便于统一ci\/cd集成中一致性原则 ）。

5. 容器共享主机内核，选用不同操作系统版本的容器，目的是与程序兼容，对内核有更改或权限需求的应用需慎重容器化

6. 建议每容器运行一个进程，但多进程容器不可避免，在充分理解应用的基础上做应用拆分。
7. 结合平台日志方案 \( 采用指定的日志输出方式，对应用是否支持进一步确认）
8. 极致的网络性能要求应用\(docker 网络有一定性能损耗）

# 二、容器化PAAS应用主要优势

1. 在可移植性、一致性以及打包具有众多依赖的服务这些方面非常优势
2. 在可移植性、一致性以及打包具有众多依赖的服务这些方面非常优势从根本上改变了开发人员与DevOps 团队之间的交互界面从而极大简化了开发之间的沟通需求与责任边界

## 三、PAAS 平台应用准备原则

1. 确定了解产品定位及需求，特别是首次迭代的范围

2. 确定了解应用目前技术选型，根据目前的技术选型为开发者确认目前平台是否支持建立对应的开发环境及技术栈，例如：使用java环境，Python环境，Ruby 环境，数据库环境，中间件，测试插件工具选择等等。

3. 了解技术框架和服务情况，包括日志、存储、消息、缓存、搜索、数据源、集群扩展方式等等

4. 确定业务代码托管


### 风险提示

1. 管理依赖的责任推给了开发人员，开发人员可以快速迭代的同时，并非每位开发人员都有能力或已经有接管部分运维工作的责任意识。工作流的适应要有一些的时间 。

## 四、云课堂应用架构拆分说明

```
 现云课堂在进行第一步骤的容器化实施后，整体结构为使用一台提供ssh 功能的容器，在之上试安装运行nodejs，mongodb，redis，pm2，云课堂系统。目前测试功能没有问题。
```

从提供的安装文档来看，部署环境要求Redhat6.4 64位，所有应用采用源码安装包方式放置在\/ykt 目录下。

在此基础上，与应用协商服务拆分粒度及组件方式，应用在容器化环境的推荐拓扑如下：

![](/assets/492341372111540144.jpg)

结合rancher 平台特点，与应用方开发人员确认计划修改部署细节 。具体内容如下：

```
   1. 使用Rancher平台自带haproxy 实现负载访问

   2. mongodb cluster 替代单点mongo结构

   3.将nodejs ，redis 及云课堂应用部署在一台容器，使用pm2作为容器进程管理工具，保证应用一致及自动重启。
```

## 五、容器构建流程

