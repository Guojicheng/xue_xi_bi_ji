# 第三方应用迁移容器云平台标准流程说明

### 目录

## 一、概述

本文档目的为民生保险在测试及生产环境下，如何将第三方的应用在 Rancher容器云平台及Wisebuild 管理平台得到合理的部署及应用，并提高效率及性能提供一定的建议及标准流程规范。我们在结合Rancher及民生保险现有的业务流程， 梳理各个单元的优缺点及相关性的基础上总结提出几个实现第三方应用容器化的合理步骤，并细化设计规范各流程的标准输入、输出管理需求，力求保障本流程能够顺利的在需要部署不同应用类型、来源及技术背景的应用需求下发挥最佳推荐路线图的作用。

通常，一个第三方的应用首先需要在了解现有容器云管理平台提供的基础功能的基础了上，合理规划及分拆自身现有应用的组织结构，并需要在容器化场景下做最基础的功能验证，然后遵循云平台管理的标准规范要求进行实施部署，本文详细说明各个细分阶段的任务目标及对人员、文档及任务输入、输出规范要求，以在规范化、量化的基础上保障运行、提升效率。

# 二、平台功能详述

## **Rancher容器云管理平台提供哪些功能**

构建独立的容器通讯网络： Rancher 为每个环境生成一个软件定义网络，用于容器之间及跨主机的容器之间通讯，并通过构建的IPSEC隧道提供了跨宿主机容器之间安全的网络通讯。

持久化存储服务： Rancher对Docke提供持久化存储服务的驱动，目前的convoy 组件支持nfs 等。

容器的负载均衡。Rancher提供的内置、弹性负载均衡能力在容器之间或者服务之间分发流量（集群整合Haproxy,支持自动生成及自定义配置），负载均衡服务可以跨多个云工作。

服务发现：Rancher 实现了分布式服务发现功能，具有内置的健康检查功能，并使容器自动地注册自己到相应至相应服务，并且各种服务之间可以在网络上动态地彼此发现。

多租户和用户环境：Rancher 为多用户而设计，企业各个部门间可以跨应用生命周期协作。通过与已有目录服务的集成，Rancher 的用户可以创建独立的开发，测试和生产环境，然后邀请相关人员一起协作地管理资源和应用。

服务升级：通过使用服务克隆和请求重定向功能，Rancher 使用户能更加容易地升级以及存在的容器服务。这让新版本的服务在处理生产流量前，有机会在其所依赖的生产环境中被校验和确认。

多编排引擎支持：Rancher 用户在创建环境的时候，可以为他们的容器选择不同的容器编排引擎，默认是 Cattle，或者是 Kubernets 和 Docker Swarm。这让用户可以选择任意市场领先的调度框架的同时，依然能利用到Ranher 的其它所有功能，如：应用商店（将复杂应用配置预定义，并一键部署），企业级用户管理，容器网络，和存储技术。

## **在Rancher平台部署容器化应用与通常应用部署的区别**

一个标准的应用的容器化**构建**流程，通常简单的被认为构建和运行虚拟机的方式是一样的，但要求应用在构建时使用一套基于Docker 及Rancher平台支持的服务发现机制、dockerfile定制规范及在应用架构设计上能够配合使用rancher提供的横向扩展、负载分担，服务发现、日志采集等功能，以最大程度的达到应用容器化及容器管理平台真正的价值。在流程上具体大为：

### （1） 设计应用框架，合理规划扩展性能及方式，尽量将应用分拆为多个镜像（微服务方式），设计应用各组件的拓扑关系，并将镜像上传到仓库。

### （2） 构建系统及应用并保存镜像

#### 方式一 、使用Dockerfile 统一构建

#### 方式二、 使用CI\/CD 系统在代码提交时自动构建

 一般会使用Jenkins 或Codeship 这样的CI\\/CD系统，在代码提交时自动构建镜像，一旦构建完毕，将被发送到镜像仓库中，自动化测试系统可以从中下载并运行该镜像。在企业级用户中，我们推荐使用Wise2c

### （3） 下载镜像到某台宿主机,以容器方式运行基于该镜像的容器

### （4） 通过服务发现及内部配置信息将容器连接到其它服务，调用其它容器服务组件，组成整体应用。示例应用的结构示意如下

![](/assets/图片1.png)

### （5） 通过映射为外服务端口提供应用对外访问

### （6） 配置由平台统一管理日志（发送指定位置）

### （7） 由平台监控容器。

## **Rancher 平台容器间服务发现及应用访问、负载机制说明**

[     Rancher](http://www.dockerinfo.net/rancher)的服务发现就是基于rancher-dns来实现，创建的stack&service都会生成相应的DNS记录，用户可以通过相应的规则进行访问，这样在微服务之间就可以无需知晓各自的IP地址，直接用服务名进行连接即可。

```
 内部DNS的使用其实比单纯使用LB暴露IP+Port方式更加简洁，因为这样无需考虑微服务的容器漂移导致的服务IP出现变化。同时在加构设计时也支持使用zookeeper、etcd、consul、Eureka、Smartstack 容器用于共享配置和服务发现

  Rancher 平台层面使用**rancher-dns**来实现**服务发现**机制；使用**rancher-metadata**动态向微服务所在容器中注入一些**配置数据**， Rancher内置的负载均衡是基于**Haproxy**实现的并提供**healthcheck**来保证微服务的高可用，Haproxy支持TCP\/HTTP，当unhealthy触发时按照预先设置的策略执行。
```

## **外部访问Rancher 服务方式**

目前外部访问Rancher内部服务方法主要有以DNS绑定或负载均衡VIP。

Rancher提供external-dns、external-lb框架可以让高级用户依据自身的场景需求设计，external-dns除了支持公共的DNS服务（如route53），还支持内部DNS服务器（如bind9），而external-lb目前支持F5设备。

```
二、平台功能详述
```

```
 平台主要功能简介 ：
    包括说明云平台主要模块及功能 《容器云平台总体设计功能说明文档》
```

```
推荐的应用容器网设计原则 ：

       平台网络机制说明主机网络、容器网络及平台网络

       容器存储

       平台服务发现功能应用方式推荐
```

## 三、 业务流程说明（初稿）

1. ### 迁移工作量及难度评估标准表格（excel 调查表）

2. ### 通常的应用迁移到云平台的步骤流程说明

  #### 第1步骤：平台功能说明及应用适用性初步交流阶段

  ##### 阶段目标（输入）

  本阶段目的为确定应用是否适用于容器平台，及初步评估工作周期及工作量。预估相关的困难度及预设实施周期。

  ##### 阶段参与人员技能要求说明：

  参与人员要求     知识储备要求     表格内容填写人员角色要求

  ##### 阶段人员责任分区及相关说明：

  ##### 阶段输出

  应用容器化需求评估总结文档（输出表格方式）

  #### 第2步骤： 应用容器化功能功能方案调研及验证调试阶段

  ##### 阶段目标（输入\)

  本阶段要求确定并验证应用服务拆分方案，并在此基础上出具相应的服务发现机制等改造方案文档，测试文档及应用发现机制说明文档，应用日志输出方案说明文档。

  ##### 阶段技能要求：

  本阶段沟通应在涉及双方的沟通人员对云平台功能有较明确的了解并明确第三方应用将在平台实现的最后需求或目标效果的基础之上，对应用的分拆粒度，分拆方式及服务发现方式、负载均衡方案、参数传递方式、应用更新及日志输出方案做具体的设计。并依据此需求进行相应的测试验证工作。

  ##### 阶段人员职责明确及相关说明：

  参与人员要求 知识储备要求 表格内容填写人员角色要求

  ##### 阶段（输出 ）

  应用服务拆分整体设计方案， 应用服务拆方案验证及实施配置文档

  #### 第3步骤：应用标准化改造实施阶段

  ##### 阶段目标（输入\)

  在功能完整性验证的基础上，遵循容器化平台生产环境应用部署需求，依照《容器化基础原则》，《微服务框架在rancher平台的应用部署标准》等要求，梳理从应用基础镜像及服务发现、负载机制、扩展能力等参数指标。在确认功能的基础上，基于rancher-compose 及docker-compose 制作统一的一键部署商店应用并进行测试。

  ##### 阶段技能要求：

  ##### 阶段人员职责明确及相关说明：

  参与人员要求 知识储备要求 表格内容填写人员角色要求

  ##### 阶段（输出 ）

  一键部署应用商店代码， 扩展、负载等功能验证文档


